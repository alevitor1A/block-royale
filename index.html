<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Block Royale - OMNI ULTIMATE</title>
    <style>
        body { background: #0a0a0c; margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: white; user-select: none; }
        canvas { display: block; cursor: crosshair; }

        /* HUD PREMIUM RESTAURADA */
        #ui-layer { position: absolute; top: 20px; left: 20px; pointer-events: none; display: flex; flex-direction: column; gap: 10px; z-index: 10; }
        .stat-box { 
            background: rgba(0, 0, 0, 0.85); padding: 15px 20px; border-radius: 10px; 
            border-left: 6px solid #00d2ff; font-weight: 900; font-size: 13px; 
            text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            min-width: 200px; backdrop-filter: blur(5px);
        }
        .stat-box span { color: #00d2ff; font-size: 18px; float: right; text-shadow: 0 0 10px rgba(0,210,255,0.5); }
        .gold span { color: #ffee00; }
        .danger { border-left-color: #ff4444; }
        .danger span { color: #ff4444; }

        /* BOSS UI */
        #boss-ui { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); width: 500px; text-align: center; display: none; z-index: 20; }
        #boss-bar { width: 100%; height: 22px; background: rgba(0,0,0,0.7); border: 2px solid #ff0055; border-radius: 11px; overflow: hidden; box-shadow: 0 0 20px rgba(255,0,85,0.3); }
        #boss-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ff0055, #ff4444); transition: width 0.3s ease; }

        /* LOJA SUPREMA */
        #shop-overlay { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: rgba(15, 15, 20, 0.98); padding: 40px; border-radius: 25px; 
            border: 3px solid #ffee00; display: none; text-align: center; z-index: 100;
            box-shadow: 0 0 100px rgba(255, 238, 0, 0.2);
        }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px; }
        .shop-item { 
            background: #25252b; padding: 20px; border-radius: 15px; cursor: pointer; 
            border: 1px solid #444; transition: 0.2s;
        }
        .shop-item:hover { transform: scale(1.05); border-color: #ffee00; background: #333; }
        .shop-item h3 { margin: 0; color: #ffee00; }
        .shop-item p { color: #aaa; font-size: 12px; margin-top: 5px; }

        /* TELA DE LOGIN */
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 200; }
        #login-card { background: #16161a; padding: 50px; border-radius: 30px; border: 1px solid #00d2ff; text-align: center; width: 400px; box-shadow: 0 0 50px rgba(0,210,255,0.1); }
        h1 { font-size: 42px; margin-bottom: 30px; letter-spacing: 3px; color: #00d2ff; text-shadow: 0 0 20px rgba(0,210,255,0.5); }
        input { padding: 18px; width: 100%; background: #000; color: #fff; border: 1px solid #333; border-radius: 10px; margin-bottom: 20px; text-align: center; font-size: 16px; box-sizing: border-box; }
        button { padding: 18px; width: 100%; background: #00d2ff; color: #000; border: none; font-weight: bold; font-size: 18px; border-radius: 10px; cursor: pointer; }
        #rank-display { margin-top: 25px; text-align: left; color: #888; font-size: 13px; line-height: 1.6; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="stat-box">JOGADOR: <span id="ui-name">---</span></div>
        <div class="stat-box">PATENTE: <span id="ui-rank">RECRUTA</span></div>
        <div class="stat-box gold">MOEDAS: <span id="ui-coins">0</span></div>
        <div class="stat-box danger">VIDA: <span id="ui-hp">100</span>%</div>
        <div class="stat-box">MUNI√á√ÉO: <span id="ui-ammo">20</span>/20</div>
        <div class="stat-box" style="border-left-color: #ffee00;">ONDA: <span id="ui-wave">1</span></div>
    </div>

    <div id="boss-ui">
        <div style="color: #ff0055; font-weight: 900; margin-bottom: 5px;">BOSS ESTIMADO</div>
        <div id="boss-bar"><div id="boss-fill"></div></div>
    </div>

    <div id="shop-overlay">
        <h2 style="color:#ffee00; margin:0;">LOJA DE ELITE</h2>
        <div class="shop-grid">
            <div class="shop-item" onclick="buyUpgrade('triple')"><h3>TIRO TRIPLO</h3><p>50 MOEDAS</p></div>
            <div class="shop-item" onclick="buyUpgrade('heal')"><h3>REGENERAR</h3><p>30 MOEDAS</p></div>
            <div class="shop-item" onclick="buyUpgrade('speed')"><h3>AGILIDADE</h3><p>40 MOEDAS</p></div>
            <div class="shop-item" onclick="nextWave()" style="background:#00d2ff; color:#000;"><h3>PR√ìXIMA ONDA</h3><p>GR√ÅTIS</p></div>
        </div>
    </div>

    <div id="overlay">
        <div id="login-card">
            <h1>BLOCK ROYALE</h1>
            <input type="text" id="nick-input" placeholder="SEU NICK..." maxlength="12">
            <button id="btn-play">INICIAR COMBATE</button>
            <div id="rank-display">Carregando Ranking...</div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD4SyFFNHI1k2Nn0LwlGwXBpK5LG9q6rXg",
            authDomain: "vit4lynv-1fb7c.firebaseapp.com",
            projectId: "vit4lynv-1fb7c",
            storageBucket: "vit4lynv-1fb7c.firebasestorage.app",
            messagingSenderId: "418954009350",
            appId: "1:418954009350:web:9bf8fadb44f81cf8815c87"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameActive = false, inShop = false;
        let userData = { name: "", kills: 0 };
        let coins = 0, wave = 1, sessionKills = 0, screenShake = 0;
        let hasTripleShot = false, playerSpeed = 4.5;

        const player = { x: 0, y: 0, size: 30, hp: 100, ammo: 20 };
        let enemies = [], bullets = [], keys = {}, mouse = { x: 0, y: 0 };

        const biomes = [
            { bg: '#111116', floor: '#1a1a20', name: 'ZONA NEUTRA' },
            { bg: '#1a0f0f', floor: '#261515', name: 'INFERNO' },
            { bg: '#0f1a1a', floor: '#152626', name: 'PANTANO' }
        ];
        let currentBiome = biomes[0];

        async function updateRanking() {
            const snap = await get(child(ref(db), 'players'));
            if (snap.exists()) {
                const list = Object.entries(snap.val())
                    .sort((a, b) => b[1].totalKills - a[1].totalKills).slice(0, 5);
                document.getElementById('rank-display').innerHTML = "<b>üèÜ RANKING GLOBAL:</b><br>" + 
                    list.map((p, i) => `${i+1}¬∫ ${p[0]} - ${p[1].totalKills} Kills`).join("<br>");
            }
        }

        window.buyUpgrade = function(type) {
            if(type === 'triple' && coins >= 50 && !hasTripleShot) { coins -= 50; hasTripleShot = true; }
            if(type === 'heal' && coins >= 30) { coins -= 30; player.hp = 100; }
            if(type === 'speed' && coins >= 40) { coins -= 40; playerSpeed += 1; }
            updateUI();
        }

        window.nextWave = function() {
            document.getElementById('shop-overlay').style.display = 'none';
            document.getElementById('boss-ui').style.display = 'none';
            inShop = false;
            currentBiome = biomes[Math.floor((wave-1)/5) % biomes.length];
            if(wave % 5 === 0) spawnBoss();
            else for(let i=0; i < 3 + wave; i++) spawnEnemy();
            updateUI();
        }

        function updateUI() {
            document.getElementById('ui-name').innerText = userData.name;
            document.getElementById('ui-coins').innerText = coins;
            document.getElementById('ui-hp').innerText = Math.ceil(player.hp);
            document.getElementById('ui-ammo').innerText = player.ammo;
            document.getElementById('ui-wave').innerText = wave;
            document.getElementById('ui-rank').innerText = (userData.kills + sessionKills) > 100 ? "VETERANO" : "RECRUTA";
        }

        function spawnEnemy() {
            const side = Math.floor(Math.random() * 4);
            let x, y;
            if(side===0){x=Math.random()*canvas.width; y=-50;}
            else if(side===1){x=canvas.width+50; y=Math.random()*canvas.height;}
            else if(side===2){x=Math.random()*canvas.width; y=canvas.height+50;}
            else {x=-50; y=Math.random()*canvas.height;}
            enemies.push({ x, y, speed: 1.8 + (wave*0.1), hp: 1, size: 32, color: '#ff4444', isBoss: false });
        }

        function spawnBoss() {
            document.getElementById('boss-ui').style.display = 'block';
            enemies.push({ 
                x: canvas.width/2, y: -100, speed: 1.2, 
                hp: 30 + (wave*10), maxHp: 30 + (wave*10), 
                size: 120, color: '#ff0055', isBoss: true 
            });
        }

        function drawFace(en) {
            ctx.fillStyle = 'black';
            let s = en.size;
            if(en.isBoss) {
                ctx.fillStyle = 'red';
                ctx.fillRect(en.x - s/4, en.y - s/4, 20, 20); ctx.fillRect(en.x + s/8, en.y - s/4, 20, 20);
                ctx.fillStyle = 'black'; ctx.fillRect(en.x - s/3, en.y + s/6, s/1.5, 10);
            } else {
                ctx.fillRect(en.x - s/4, en.y - s/4, 6, 6); ctx.fillRect(en.x + s/8, en.y - s/4, 6, 6);
                ctx.fillRect(en.x - s/6, en.y + s/8, s/3, 3);
            }
        }

        function gameLoop() {
            if (!gameActive || inShop) return;
            
            ctx.fillStyle = currentBiome.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Desenhar ch√£o quadriculado
            ctx.strokeStyle = currentBiome.floor;
            for(let i=0; i<canvas.width; i+=100) {
                ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i, canvas.height); ctx.stroke();
            }
            for(let j=0; j<canvas.height; j+=100) {
                ctx.beginPath(); ctx.moveTo(0,j); ctx.lineTo(canvas.width, j); ctx.stroke();
            }

            // Jogador
            if (keys['w']) player.y -= playerSpeed; if (keys['s']) player.y += playerSpeed;
            if (keys['a']) player.x -= playerSpeed; if (keys['d']) player.x += playerSpeed;
            
            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(Math.atan2(mouse.y - player.y, mouse.x - player.x));
            ctx.fillStyle = '#00d2ff'; ctx.fillRect(-15, -15, 30, 30);
            ctx.fillStyle = '#333'; ctx.fillRect(10, -5, 15, 10);
            ctx.restore();

            // Inimigos
            enemies.forEach((en, i) => {
                const dist = Math.hypot(player.x - en.x, player.y - en.y);
                en.x += ((player.x - en.x)/dist) * en.speed;
                en.y += ((player.y - en.y)/dist) * en.speed;
                ctx.fillStyle = en.color;
                ctx.fillRect(en.x - en.size/2, en.y - en.size/2, en.size, en.size);
                drawFace(en);

                if(en.isBoss) document.getElementById('boss-fill').style.width = (en.hp/en.maxHp*100)+'%';
                if(dist < en.size/2 + 15) {
                    player.hp -= 0.5; updateUI();
                    if(player.hp <= 0) endGame();
                }
            });

            // Balas
            bullets.forEach((b, bi) => {
                b.x += b.vx; b.y += b.vy;
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(b.x, b.y, 5, 0, 7); ctx.fill();
                enemies.forEach((en, ei) => {
                    if(Math.hypot(b.x - en.x, b.y - en.y) < en.size/2) {
                        en.hp--; bullets.splice(bi, 1);
                        if(en.hp <= 0) {
                            coins += en.isBoss ? 100 : 10; sessionKills++;
                            enemies.splice(ei, 1);
                            if(enemies.length === 0) { 
                                wave++; inShop = true; 
                                document.getElementById('shop-overlay').style.display = 'block'; 
                            }
                        }
                        updateUI();
                    }
                });
            });

            requestAnimationFrame(gameLoop);
        }

        async function endGame() {
            gameActive = false;
            await set(ref(db, 'players/' + userData.name), { totalKills: userData.kills + sessionKills });
            location.reload();
        }

        window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
        window.addEventListener('mousedown', () => {
            if(!gameActive || inShop || player.ammo <= 0) return;
            const ang = Math.atan2(mouse.y - player.y, mouse.x - player.x);
            const shoot = (a) => bullets.push({x: player.x, y: player.y, vx: Math.cos(a)*15, vy: Math.sin(a)*15});
            shoot(ang);
            if(hasTripleShot) { shoot(ang+0.2); shoot(ang-0.2); }
            player.ammo--; updateUI();
            if(player.ammo <= 0) setTimeout(() => { player.ammo=20; updateUI(); }, 1000);
        });
        window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });

        document.getElementById('btn-play').addEventListener('click', async () => {
            const nick = document.getElementById('nick-input').value.toUpperCase();
            if(nick.length < 3) return;
            const snap = await get(child(ref(db), 'players/' + nick));
            userData.name = nick;
            userData.kills = snap.exists() ? snap.val().totalKills : 0;
            document.getElementById('overlay').style.display = 'none';
            gameActive = true; player.x = canvas.width/2; player.y = canvas.height/2;
            nextWave(); gameLoop();
        });

        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        updateRanking();
    </script>
</body>
</html>
