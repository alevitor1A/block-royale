<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Block Survival Royale - Online</title>
    <style>
        body { background: #121212; margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: white; user-select: none; }
        canvas { display: block; background: #1e1e24; cursor: crosshair; }

        /* HUD */
        #ui-layer { position: absolute; top: 20px; left: 20px; pointer-events: none; display: flex; flex-direction: column; gap: 10px; }
        .stat-box { background: rgba(0, 0, 0, 0.7); padding: 10px 15px; border-left: 4px solid #00d2ff; border-radius: 4px; font-weight: bold; font-size: 14px; text-transform: uppercase; }
        .stat-box span { color: #00d2ff; }
        .rank-box { border-left-color: #888; }

        /* Telas */
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        h1 { font-size: 50px; text-shadow: 0 0 20px #00d2ff; margin-bottom: 10px; }
        
        /* Formulário de Login */
        #login-form { display: flex; flex-direction: column; gap: 15px; align-items: center; }
        input { padding: 12px; font-size: 18px; border-radius: 5px; border: none; width: 250px; text-align: center; }
        button { padding: 15px 40px; font-size: 20px; background: #00d2ff; border: none; color: #000; font-weight: bold; cursor: pointer; border-radius: 5px; transition: 0.2s; }
        button:hover { transform: scale(1.05); background: #fff; box-shadow: 0 0 20px #00d2ff; }
        
        #status-msg { margin-top: 10px; color: #00d2ff; font-size: 14px; }
        #reload-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ff4444; font-weight: bold; display: none; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="stat-box">JOGADOR: <span id="player-name-display">---</span></div>
        <div class="stat-box rank-box">PATENTE: <span id="rank-display">RECRUTA</span></div>
        <div class="stat-box">KILLS TOTAIS: <span id="kills-display">0</span></div>
        <div class="stat-box">VIDA: <span id="hp">100</span>%</div>
        <div class="stat-box">MUNIÇÃO: <span id="ammo">20</span>/20</div>
    </div>

    <div id="reload-msg">RECARREGANDO (R)...</div>

    <div id="overlay">
        <h1>BLOCK ROYALE</h1>
        <div id="login-form">
            <input type="text" id="username" placeholder="Digite seu apelido..." maxlength="12">
            <button id="startBtn">ENTRAR NO JOGO</button>
            <p id="status-msg">Conectando ao banco de dados...</p>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script type="module">
        // --- CONFIGURAÇÃO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD4SyFFNHI1k2Nn0LwlGwXBpK5LG9q6rXg",
            authDomain: "vit4lynv-1fb7c.firebaseapp.com",
            projectId: "vit4lynv-1fb7c",
            storageBucket: "vit4lynv-1fb7c.firebasestorage.app",
            messagingSenderId: "418954009350",
            appId: "1:418954009350:web:9bf8fadb44f81cf8815c87"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const statusMsg = document.getElementById('status-msg');
        statusMsg.innerText = "Servidor Online ✓";

        // --- LÓGICA DO JOGO ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameRunning = false;
        let currentPlayer = { name: "", totalKills: 0 };
        let matchKills = 0;

        // Patentes
        const getRank = (k) => {
            if (k >= 1000000) return { n: "LOB", c: "#ff00ea" };
            if (k >= 35600) return { n: "GAST", c: "#cd7f32" };
            if (k >= 1000) return { n: "GOT", c: "#ffffff" };
            return { n: "RECRUTA", c: "#888" };
        };

        async function login() {
            const name = document.getElementById('username').value.trim();
            if (!name) return alert("Digite um nome!");
            
            statusMsg.innerText = "Carregando perfil...";
            const snapshot = await get(child(ref(db), `players/${name}`));
            
            if (snapshot.exists()) {
                currentPlayer = { name: name, totalKills: snapshot.val().totalKills || 0 };
            } else {
                currentPlayer = { name: name, totalKills: 0 };
            }

            document.getElementById('player-name-display').innerText = currentPlayer.name;
            updateUI();
            startGame();
        }

        async function saveScore() {
            const newTotal = currentPlayer.totalKills + matchKills;
            await set(ref(db, 'players/' + currentPlayer.name), {
                totalKills: newTotal,
                lastSeen: new Date().toISOString()
            });
            currentPlayer.totalKills = newTotal;
            updateUI();
        }

        // Sistema de Jogo Simples
        const player = { x: 0, y: 0, size: 30, hp: 100, ammo: 20 };
        let enemies = [], projectiles = [], keys = {}, mouse = {x:0, y:0};

        function updateUI() {
            const rank = getRank(currentPlayer.totalKills);
            document.getElementById('rank-display').innerText = rank.n;
            document.getElementById('rank-display').style.color = rank.c;
            document.getElementById('kills-display').innerText = currentPlayer.totalKills;
            document.getElementById('hp').innerText = player.hp;
            document.getElementById('ammo').innerText = player.ammo;
        }

        function startGame() {
            document.getElementById('overlay').style.display = 'none';
            gameRunning = true;
            matchKills = 0;
            player.hp = 100;
            player.x = window.innerWidth/2; player.y = window.innerHeight/2;
            enemies = []; projectiles = [];
            requestAnimationFrame(gameLoop);
        }

        function gameOver() {
            gameRunning = false;
            saveScore();
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('status-msg').innerText = "Kills salvas! Clique para jogar de novo.";
            document.getElementById('startBtn').innerText = "JOGAR NOVAMENTE";
        }

        // Controles e Loop
        window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
        window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
        window.addEventListener('mousedown', () => { if(gameRunning && player.ammo > 0) shoot(); });
        document.getElementById('startBtn').addEventListener('click', login);

        function shoot() {
            const angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
            projectiles.push({x: player.x, y: player.y, vx: Math.cos(angle)*10, vy: Math.sin(angle)*10});
            player.ammo--;
            updateUI();
        }

        function gameLoop() {
            if(!gameRunning) return;
            ctx.clearRect(0,0,canvas.width, canvas.height);
            
            // Mover jogador
            if(keys['w']) player.y -= 4; if(keys['s']) player.y += 4;
            if(keys['a']) player.x -= 4; if(keys['d']) player.x += 4;

            // Desenhar jogador
            ctx.fillStyle = "#00d2ff";
            ctx.fillRect(player.x-15, player.y-15, 30, 30);

            // Inimigos
            if(Math.random() < 0.02) enemies.push({x: Math.random()*canvas.width, y: -20});
            enemies.forEach((en, i) => {
                en.y += 2;
                ctx.fillStyle = "red";
                ctx.fillRect(en.x, en.y, 25, 25);
                if(en.y > canvas.height) enemies.splice(i,1);
                
                // Colisão
                if(Math.hypot(player.x - en.x, player.y - en.y) < 25) {
                    player.hp -= 20; updateUI(); enemies.splice(i,1);
                    if(player.hp <= 0) gameOver();
                }
            });

            // Balas
            projectiles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy;
                ctx.fillStyle = "yellow";
                ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, 7); ctx.fill();
                
                enemies.forEach((en, ei) => {
                    if(Math.hypot(p.x - en.x, p.y - en.y) < 20) {
                        enemies.splice(ei,1); projectiles.splice(i,1);
                        matchKills++;
                    }
                });
            });

            requestAnimationFrame(gameLoop);
        }

        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    </script>
</body>
</html>
